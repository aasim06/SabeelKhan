<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raza Glass</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            padding: 20px;
        }
        .form-row {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .order-item {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #0d6efd;
        }
        .client-table-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 25px;
        }
        .order-summary {
            font-weight: bold;
            background-color: #e7f1ff !important;
        }
        .completed-order {
            background-color: #e8f5e9 !important;
        }
        #invoiceModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .invoice-header {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .invoice-footer {
            border-top: 2px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #invoicePrintContainer, #invoicePrintContainer * {
                visibility: visible;
            }
            #invoicePrintContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        @media (max-width: 767.98px) {
  .client-table-container table {
    width: 100%;
    border-collapse: collapse;
  }

  .client-table-container table thead {
    display: none;
  }

  .client-table-container table tbody {
    display: block;
  }

  .client-table-container table tr {
    display: flex;
    flex-direction: column;
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: #fff;
  }

  .client-table-container table td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border: none;
    border-bottom: 1px solid #eee;
    position: relative;
  }

  .client-table-container table td:last-child {
    border-bottom: none;
  }

  .client-table-container table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
    flex-basis: 45%;
    text-align: left;
  }

  .client-table-container table td[data-label="Action"] {
    justify-content: center;
    text-align: center;
  }

  .client-table-container table td[data-label="Action"]::before {
    display: none;
  }

  .client-table-container table tr.order-summary {
    display: none;
  }
}

    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Raza Glass</h1>
        
        <!-- Client Information -->
        <div class="form-row">
            <div class="row">
                <div class="col-4 mb-3">
                    <label for="clientName" class="form-label">Name:</label>
                    <input type="text" id="clientName" placeholder="Name" class="form-control" required autocomplete="off">
                    <div id="clientNameAutocomplete" class="autocomplete-items"></div>
                </div>
                <div class="col-4 mb-3">
                    <label for="clientNumber" class="form-label">Number:</label>
                    <input type="text" id="clientNumber" placeholder="Number" class="form-control" required>
                </div>
                <div class="col-4 mb-3">
                    <label for="clientAddress" class="form-label">Address:</label>
                    <input type="text" id="clientAddress" placeholder="Address" class="form-control" required>
                </div>
            </div>
        </div>
        
        
        <!-- Mode Switcher -->
         <!-- <div class="form-row">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Measurement Mode</label>
                    <select id="measurementMode" class="form-select">
                        <option value="market">Market Method (รท100)</option>
                        <option value="accurate">Accurate Method (รท144)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="showStandardRates" checked>
                        <label class="form-check-label" for="showStandardRates">Show Standard Rates</label>
                    </div>
                </div>
            </div>
        </div>  -->
        
        <!-- Order Items Section -->
        <h2>Order Items</h2>
        <div id="orderItemsContainer">
            <!-- Order items will be added here -->
        </div>

        <!-- Add New Item Form -->
        <div class="form-row">
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">Glass Type</label>
                    <select id="newGlassType" class="form-select glass-type" required>
                        <option value="">Select</option>
                        <option value="CLEAR">CLEAR</option>
                        <option value="BROWN REFLECTIVE">BROWN REFLECTIVE</option>
                        <option value="DARK BLUE REFLECTIVE">DARK BLUE REFLECTIVE</option>
                        <option value="GREEN REFLECTIVE">GREEN REFLECTIVE</option>
                        <option value="MIRROR">MIRROR</option>
                        <option value="FROSTED">FROSTED</option>
                        <option value="EXTRA CLEAR">EXTRA CLEAR</option>
                    </select>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Thickness</label>
                    <select id="newThickness" class="form-select thickness" required>
                        <option value="">Select</option>
                        <option value="3mm">3mm</option>
                        <option value="4mm">4mm</option>
                        <option value="5mm">5mm</option>
                        <option value="6mm">6mm</option>
                        <option value="8mm">8mm</option>
                        <option value="10mm">10mm</option>
                        <option value="12mm">12mm</option>
                    </select>
                </div>
                <div class="col-4 mb-3">
                    <label class="form-label">Width (in)</label>
                    <input type="number" step="0.1" id="newWidth" class="form-control width" required>
                </div>
                <div class="col-4 mb-3">
                    <label class="form-label">Height (in)</label>
                    <input type="number" step="0.1" id="newHeight" class="form-control height" required>
                </div>
                <div class="col-4 mb-3">
                    <label class="form-label">Qty</label>
                    <input type="number" step="1" id="newQuantity" class="form-control quantity" required>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Price/Sq.Ft</label>
                    <input type="number" step="0.1" id="newPrice" class="form-control price" readonly>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Total Price</label>
                    <input type="number" step="0.1" id="newTotal" class="form-control total" readonly>
                </div>
            </div>
            <div class="col-md-6 mx-auto mb-3">
                <button id="addItemBtn" class="btn btn-success w-100 btn-sm">Add Item</button>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="form-row">
            <div class="row">
                <div class="col-4 mb-3">
                    <label for="paymentStatus" class="form-label">Payment Status:</label>
                    <select id="paymentStatus" class="form-select" required>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Partial">Partial</option>
                    </select>
                </div>
                <div class="col-4 mb-3">
                    <label for="amountPaid" class="form-label">Amount Paid:</label>
                    <input type="number" step="0.1" id="amountPaid" class="form-control">
                </div>
                <div class="col-4 mb-3">
                    <label for="remainingBalance" class="form-label">Remaining Balance:</label>
                    <input type="number" step="0.1" id="remainingBalance" class="form-control" readonly>
                </div>
            </div>
        </div>

        <div class="text-center mb-4">
            <div class="text-center mb-4">
                <button id="submitOrder" class="btn btn-primary btn-lg me-2">Submit Order</button>
                <button id="printInvoiceBtn" class="btn btn-secondary btn-lg" disabled>Print Invoice</button>
            </div>
        </div>

        <!-- Sales Summary Section -->
        <h2>Sales Summary</h2>
        <div id="clientTablesContainer">
            <!-- Client tables will be added here dynamically -->
        </div>
        
        <!-- Totals -->
        <div class="row mt-4">
            <div class="col-md-4">
                <h3>Total Sales: โจ<span id="totalSales">0.00</span></h3>
            </div>
            <div class="col-md-4">
                <h3>Pending Payments: โจ<span id="totalPending">0.00</span></h3>
            </div>
            <div class="col-md-4">
                <button id="exportAllData" class="btn btn-primary me-2">Export All Data</button>
                <button id="importAllData" class="btn btn-secondary">Import All Data</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
        
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="invoicePreview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadInvoice()">
                        <i class="bi bi-download"></i> Download PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="printInvoice()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Container (hidden) -->
    <div id="invoicePrintContainer" style="display:none;"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    

    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        
        // Settings
        const settings = {
            measurementMode: 'market', // 'accurate' or 'market'
            showStandardRates: true
        };
        
        // Glass type prices per thickness (in Rupees) with dual rates
        const glassPrices = {
            "CLEAR": {
                "3mm": { actual: 80, standard: 90 },
                "4mm": { actual: 100, standard: 110 },
                "5mm": { actual: 120, standard: 130 },
                "6mm": { actual: 140, standard: 150 },
                "8mm": { actual: 180, standard: 190 },
                "10mm": { actual: 220, standard: 230 },
                "12mm": { actual: 260, standard: 270 }
            },
            "BROWN REFLECTIVE": {
                "5mm": { actual: 180, standard: 190 },
                "6mm": { actual: 200, standard: 210 }
            },
            "DARK BLUE REFLECTIVE": {
                "5mm": { actual: 180, standard: 190 },
                "6mm": { actual: 200, standard: 210 }
            },
            "GREEN REFLECTIVE": {
                "4mm": { actual: 150, standard: 160 },
                "5mm": { actual: 180, standard: 190 },
                "6mm": { actual: 200, standard: 210 }
            },
            "MIRROR": {
                "3mm": { actual: 220, standard: 230 },
                "4mm": { actual: 240, standard: 250 },
                "5mm": { actual: 260, standard: 270 },
                "6mm": { actual: 280, standard: 290 }
            },
            "FROSTED": {
                "5mm": { actual: 180, standard: 190 },
                "6mm": { actual: 200, standard: 210 }
            },
            "EXTRA CLEAR": {
                "3mm": { actual: 100, standard: 110 },
                "4mm": { actual: 120, standard: 130 },
                "5mm": { actual: 140, standard: 150 },
                "6mm": { actual: 160, standard: 170 },
                "8mm": { actual: 200, standard: 210 },
                "10mm": { actual: 240, standard: 250 },
                "12mm": { actual: 280, standard: 290 }
            }
        };

        document.addEventListener('keydown', function(e) {
    if (e.code === 'F1') {
        e.preventDefault(); // Prevent page scroll
        settings.showStandardRates = !settings.showStandardRates;
        renderOrderItems(); // Refresh the display
    }
});

        let orderItems = [];
        let salesData = [];
        let clientsData = [];
        let currentOrderId = null;
        let currentInvoiceData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            if (localStorage.getItem('salesData')) {
                salesData = JSON.parse(localStorage.getItem('salesData'));
                updateSalesTable();
                calculateTotals();
            }

            if (localStorage.getItem('clientsData')) {
                clientsData = JSON.parse(localStorage.getItem('clientsData'));
            }

            // Event listeners
            document.getElementById('newGlassType').addEventListener('change', function() {
                updateThicknessOptions();
            });

            document.getElementById('newThickness').addEventListener('change', function() {
                updatePricePerSqFeet();
            });

            document.getElementById('newWidth').addEventListener('input', calculateTotal);
            document.getElementById('newHeight').addEventListener('input', calculateTotal);
            document.getElementById('newQuantity').addEventListener('input', calculateTotal);

            document.getElementById('addItemBtn').addEventListener('click', addOrderItem);
            document.getElementById('paymentStatus').addEventListener('change', updatePaymentFields);
            document.getElementById('amountPaid').addEventListener('input', updateRemainingBalance);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);
            document.getElementById('printInvoiceBtn').addEventListener('click', showInvoiceModal);

            // Client name autocomplete
            document.getElementById('clientName').addEventListener('input', function() {
                const input = this.value.toLowerCase();
                const autocompleteContainer = document.getElementById('clientNameAutocomplete');
                autocompleteContainer.innerHTML = '';
                
                if (input.length < 2) return;
                
                const suggestions = clientsData.filter(client => 
                    client.name.toLowerCase().includes(input) || 
                    client.number.includes(input)
                );
                
                suggestions.slice(0, 5).forEach(client => {
                    const item = document.createElement('div');
                    item.innerHTML = `<strong>${client.name}</strong> (${client.number}) - ${client.address}`;
                    item.addEventListener('click', function() {
                        document.getElementById('clientName').value = client.name;
                        document.getElementById('clientNumber').value = client.number;
                        document.getElementById('clientAddress').value = client.address;
                        autocompleteContainer.innerHTML = '';
                    });
                    autocompleteContainer.appendChild(item);
                });
            });

            // Click outside to close autocomplete
            document.addEventListener('click', function(e) {
                if (e.target.id !== 'clientName') {
                    document.getElementById('clientNameAutocomplete').innerHTML = '';
                }
            });
        });

        function updateThicknessOptions() {
            const glassType = document.getElementById('newGlassType').value;
            const thicknessSelect = document.getElementById('newThickness');
            thicknessSelect.innerHTML = '<option value="">Select</option>';
            
            if (glassType && glassPrices[glassType]) {
                Object.keys(glassPrices[glassType]).forEach(thickness => {
                    const option = document.createElement('option');
                    option.value = thickness;
                    option.textContent = thickness;
                    thicknessSelect.appendChild(option);
                });
            }
        }

        function updatePricePerSqFeet() {
            const glassType = document.getElementById('newGlassType').value;
            const thickness = document.getElementById('newThickness').value;
            const priceInput = document.getElementById('newPrice');
            
            if (glassType && thickness && glassPrices[glassType] && glassPrices[glassType][thickness]) {
                priceInput.value = glassPrices[glassType][thickness].actual;
                calculateTotal();
            } else {
                priceInput.value = '';
                document.getElementById('newTotal').value = '';
            }
        }

        function calculateTotal() {
            const width = parseFloat(document.getElementById('newWidth').value) || 0;
            const height = parseFloat(document.getElementById('newHeight').value) || 0;
            const quantity = parseInt(document.getElementById('newQuantity').value) || 0;
            const glassType = document.getElementById('newGlassType').value;
            const thickness = document.getElementById('newThickness').value;
            
            if(!glassType || !thickness) return;
            
            // Calculate square feet using custom method
            const areaSqFt = calculateCustomSqFt(width, height);
            
            const actualRate = glassPrices[glassType][thickness].actual;
            const standardRate = glassPrices[glassType][thickness].standard;
            
            const actualTotal = areaSqFt * actualRate * quantity;
            const standardTotal = areaSqFt * standardRate * quantity;
            
            document.getElementById('newPrice').value = actualRate;
            document.getElementById('newTotal').value = actualTotal.toFixed(2);
        }

        function calculateCustomSqFt(width, height) {
            // Convert inches to feet
            const widthFt = width / 12;
            const heightFt = height / 12;
            
            // Apply custom rounding rules
            const roundedWidth = customRound(widthFt, width);
            const roundedHeight = customRound(heightFt, height);
            
            // Return square feet
            return roundedWidth * roundedHeight;
        }

        function customRound(dimensionFt, dimensionInches) {
            // Special case for exactly 42.5 inches
            if (dimensionInches === 42.5) {
                return Math.ceil(dimensionFt);
            }
            
            if (dimensionInches <= 15) {
                // Small panels (โค15"): round UP to next 0.25 ft
                return Math.ceil(dimensionFt * 4) / 4;
            } else {
                // Larger panels (>15"): round UP to next 0.5 ft
                return Math.ceil(dimensionFt * 2) / 2;
            }
        }

        function addOrderItem() {
    // Validate inputs
    const inputs = [
        document.getElementById('newGlassType'),
        document.getElementById('newThickness'),
        document.getElementById('newWidth'),
        document.getElementById('newHeight'),
        document.getElementById('newQuantity')
    ];
    
    let isValid = true;
    inputs.forEach(input => {
        if (!input.value) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        alert('Please fill all required fields');
        return;
    }
    
    // Create order item object
    const item = {
        glassType: document.getElementById('newGlassType').value,
        thickness: document.getElementById('newThickness').value,
        width: parseFloat(document.getElementById('newWidth').value),
        height: parseFloat(document.getElementById('newHeight').value),
        quantity: parseInt(document.getElementById('newQuantity').value),
        pricePerSqFeet: parseFloat(document.getElementById('newPrice').value),
        totalPrice: parseFloat(document.getElementById('newTotal').value),
        measurementMode: settings.measurementMode,
        roundedWidth: customRound(
            parseFloat(document.getElementById('newWidth').value) / 12, 
            parseFloat(document.getElementById('newWidth').value)
        ),
        roundedHeight: customRound(
            parseFloat(document.getElementById('newHeight').value) / 12, 
            parseFloat(document.getElementById('newHeight').value)
        )
    };
    
    // Add to order items array
    orderItems.push(item);
    
    // Update UI
    renderOrderItems();
    
    // Store current glass type and thickness before clearing
    const currentGlassType = document.getElementById('newGlassType').value;
    const currentThickness = document.getElementById('newThickness').value;
    
    // Clear form (except glass type and thickness)
    document.getElementById('newWidth').value = '';
    document.getElementById('newHeight').value = '';
    document.getElementById('newQuantity').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newTotal').value = '';
    
    // Restore glass type and thickness
    document.getElementById('newGlassType').value = currentGlassType;
    updateThicknessOptions(); // Refresh thickness options based on glass type
    document.getElementById('newThickness').value = currentThickness;
    
    // Focus on width field for next entry
    document.getElementById('newWidth').focus();
}

        function renderOrderItems() {
            const container = document.getElementById('orderItemsContainer');
            container.innerHTML = '';
            
            orderItems.forEach((item, index) => {
                const areaSqIn = item.width * item.height;
                const areaSqFt = (item.roundedWidth * item.roundedHeight).toFixed(2);
                
                const standardRate = glassPrices[item.glassType][item.thickness].standard;
                const standardTotal = (item.totalPrice / item.pricePerSqFeet * standardRate).toFixed(2);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                itemDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-2">
                            <strong>Glass:</strong> ${item.glassType}
                        </div>
                        <div class="col-md-1">
                            <strong>Thick:</strong> ${item.thickness}
                        </div>
                        <div class="col-md-1">
                            <strong>Size:</strong> ${item.width}"ร${item.height}"
                        </div>
                        <div class="col-md-1">
                            <strong>Qty:</strong> ${item.quantity}
                        </div>
                        <div class="col-md-1">
                            <strong>Sq.Ft:</strong> ${areaSqFt}
                        </div>
                        <div class="col-md-2">
                            <strong>Actual Rate:</strong> ${item.pricePerSqFeet}/sq.ft
                        </div>
                        ${settings.showStandardRates ? `
                        <div class="col-md-2">
                            <strong>Standard Rate:</strong> ${standardRate}/sq.ft
                        </div>
                        ` : ''}
                        <div class="col-md-2">
                            <strong>Total:</strong> ${item.totalPrice.toFixed(2)}
                        </div>
                    </div>
                    ${settings.showStandardRates ? `
                    <div class="row mt-1">
                        <div class="col-md-6">
                            <small>Standard Price: ${standardTotal}</small>
                        </div>
                    </div>
                    ` : ''}
                    <div class="text-end mt-1">
                        <button class="btn btn-danger btn-sm remove-item" data-index="${index}">Remove</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    orderItems.splice(index, 1);
                    renderOrderItems();
                });
            });
        }

        function updatePaymentFields() {
            const paymentStatus = document.getElementById('paymentStatus').value;
            const amountPaidField = document.getElementById('amountPaid');
            const remainingBalanceField = document.getElementById('remainingBalance');
            const totalAmount = calculateOrderTotal();
            
            if (paymentStatus === 'Paid') {
                amountPaidField.value = totalAmount.toFixed(2);
                remainingBalanceField.value = 0;
                amountPaidField.readOnly = true;
            } else if (paymentStatus === 'Pending') {
                amountPaidField.value = 0;
                remainingBalanceField.value = totalAmount.toFixed(2);
                amountPaidField.readOnly = false;
            } else { // Partial
                amountPaidField.value = '';
                remainingBalanceField.value = '';
                amountPaidField.readOnly = false;
            }
        }

        function updateRemainingBalance() {
            const totalAmount = parseFloat(calculateOrderTotal());
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const remainingBalance = totalAmount - amountPaid;
            
            document.getElementById('remainingBalance').value = remainingBalance.toFixed(2);
        }

        function calculateOrderTotal() {
            return orderItems.reduce((total, item) => total + item.totalPrice, 0);
        }

        function submitOrder() {
            const clientName = document.getElementById('clientName').value;
            const clientNumber = document.getElementById('clientNumber').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').value) || 0;
            const currentDate = new Date().toLocaleDateString();
            
            // Validate client info
            if (!clientName || !clientNumber || !clientAddress) {
                alert('Please fill all client information fields');
                return;
            }
            
            // Validate at least one order item
            if (orderItems.length === 0) {
                alert('Please add at least one item to the order');
                return;
            }
            
            // If editing an existing order, remove its old entries first
            if (currentOrderId) {
                salesData = salesData.filter(item => item.orderId !== currentOrderId);
            } else {
                currentOrderId = Date.now();
            }
            
            // Create order
            const orderTotal = calculateOrderTotal();
            const paymentRatio = amountPaid / orderTotal;
            
            orderItems.forEach(item => {
                const areaSqIn = item.width * item.height;
                const areaSqFt = item.roundedWidth * item.roundedHeight;
                
                salesData.push({
                    orderId: currentOrderId,
                    clientName,
                    clientNumber,
                    clientAddress,
                    glassType: item.glassType,
                    thickness: item.thickness,
                    width: item.width,
                    height: item.height,
                    quantity: item.quantity,
                    areaSqIn: areaSqIn.toFixed(2),
                    areaSqFt: areaSqFt.toFixed(2),
                    roundedWidth: item.roundedWidth,
                    roundedHeight: item.roundedHeight,
                    pricePerSqFeet: item.pricePerSqFeet,
                    standardPricePerSqFeet: glassPrices[item.glassType][item.thickness].standard,
                    totalPrice: item.totalPrice,
                    amountPaid: paymentStatus === 'Paid' ? item.totalPrice : 
                               paymentStatus === 'Pending' ? 0 : 
                               (item.totalPrice * paymentRatio).toFixed(2),
                    remainingBalance: paymentStatus === 'Paid' ? 0 : 
                                    paymentStatus === 'Pending' ? item.totalPrice : 
                                    (item.totalPrice - (item.totalPrice * paymentRatio)).toFixed(2),
                    paymentStatus,
                    date: currentDate,
                    isCompleted: paymentStatus === 'Paid',
                    measurementMode: settings.measurementMode
                });
            });
            
            // Save client information if not already saved
            const clientExists = clientsData.some(client => 
                client.number === clientNumber
            );
            
            if (!clientExists) {
                clientsData.push({
                    name: clientName,
                    number: clientNumber,
                    address: clientAddress
                });
                localStorage.setItem('clientsData', JSON.stringify(clientsData));
            }
            
            // Save to localStorage
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // Update UI
            updateSalesTable();
            calculateTotals();
            
            // Enable print button
            document.getElementById('printInvoiceBtn').disabled = false;
            
            // Reset form
            document.getElementById('clientName').value = '';
            document.getElementById('clientNumber').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('paymentStatus').value = 'Paid';
            document.getElementById('amountPaid').value = '';
            document.getElementById('remainingBalance').value = '';
            
            // Clear order items
            orderItems = [];
            renderOrderItems();
            
            // Reset button text
            document.getElementById('submitOrder').textContent = 'Submit Order';
            currentOrderId = null;
            
            alert('Order submitted successfully!');
        }

        function editOrder(orderId) {
            const orderItemsToEdit = salesData.filter(item => item.orderId === orderId);
            if (orderItemsToEdit.length === 0) return;

            const order = orderItemsToEdit[0];
            
            // Fill client information
            document.getElementById('clientName').value = order.clientName;
            document.getElementById('clientNumber').value = order.clientNumber;
            document.getElementById('clientAddress').value = order.clientAddress;
            
            // Fill payment information
            document.getElementById('paymentStatus').value = order.paymentStatus;
            document.getElementById('amountPaid').value = orderItemsToEdit.reduce((sum, item) => sum + parseFloat(item.amountPaid), 0);
            document.getElementById('remainingBalance').value = orderItemsToEdit.reduce((sum, item) => sum + parseFloat(item.remainingBalance), 0);
            
            // Set measurement mode
            // settings.measurementMode = order.measurementMode;
            // document.getElementById('measurementMode').value = order.measurementMode;
            
            // Clear existing order items
            orderItems = [];
            document.getElementById('orderItemsContainer').innerHTML = '';
            
            // Add all items from the order to the editing form
            orderItemsToEdit.forEach(item => {
                document.getElementById('newGlassType').value = item.glassType;
                updateThicknessOptions();
                document.getElementById('newThickness').value = item.thickness;
                document.getElementById('newWidth').value = item.width;
                document.getElementById('newHeight').value = item.height;
                document.getElementById('newQuantity').value = item.quantity;
                updatePricePerSqFeet();
                addOrderItem();
            });
            
            // Set current order ID for reference
            currentOrderId = orderId;
            
            // Change submit button text
            document.getElementById('submitOrder').textContent = 'Update Order';
            
            // Scroll to the top of the form
            window.scrollTo(0, 0);
        }

        function showInvoiceModal() {
            if (!currentOrderId) {
                alert('No order selected for invoice');
                return;
            }
            
            // Get order data
            const orderItems = salesData.filter(item => item.orderId === currentOrderId);
            if (orderItems.length === 0) {
                alert('Order not found');
                return;
            }
            
            const order = orderItems[0]; // First item contains all order info
            
            // Prepare invoice data
            currentInvoiceData = {
                orderId: order.orderId,
                clientName: order.clientName,
                clientNumber: order.clientNumber,
                clientAddress: order.clientAddress,
                date: order.date,
                paymentStatus: order.paymentStatus,
                items: orderItems.map(item => ({
                    description: `${item.glassType} (${item.thickness})`,
                    size: `${item.width}" ร ${item.height}"`,
                    quantity: item.quantity,
                    area: item.areaSqFt,
                    roundedWidth: item.roundedWidth,
                    roundedHeight: item.roundedHeight,
                    rate: item.pricePerSqFeet,
                    standardRate: item.standardPricePerSqFeet,
                    amount: item.totalPrice
                })),
                subtotal: orderItems.reduce((sum, item) => sum + item.totalPrice, 0),
                amountPaid: orderItems.reduce((sum, item) => sum + parseFloat(item.amountPaid), 0),
                balanceDue: orderItems.reduce((sum, item) => sum + parseFloat(item.remainingBalance), 0),
                measurementMode: order.measurementMode
            };
            
            // Generate invoice HTML
            const invoicePreview = document.getElementById('invoicePreview');
            invoicePreview.innerHTML = `
                <div class="invoice-header text-center">
                    <h2>Raza Glass and Aluminum</h2>
                    <p>Phularwan</p>
                    <p>Phone: 0302-7026191 | Email: sabeelkhan@gmail.com</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>Bill To:</h4>
                        <p><strong>${currentInvoiceData.clientName}</strong></p>
                        <p>${currentInvoiceData.clientAddress}</p>
                        <p>Phone: ${currentInvoiceData.clientNumber}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <h4>Invoice #: INV-${currentInvoiceData.orderId.toString().slice(-6)}</h4>
                        <p><strong>Date:</strong> ${currentInvoiceData.date}</p>
                        <p><strong>Status:</strong> ${currentInvoiceData.paymentStatus}</p>
                        <p><strong>Measurement Mode:</strong> ${currentInvoiceData.measurementMode === 'accurate' ? 'Accurate (รท144)' : 'Market (รท100)'}</p>
                    </div>
                </div>
                
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Size</th>
                            <th>Qty</th>
                            <th>Area (sq.ft)</th>
                            
                            <th>Rate</th>
                            ${settings.showStandardRates ? '<th>Std Rate</th>' : ''}
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentInvoiceData.items.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.description}</td>
                                <td>${item.size}</td>
                                <td>${item.quantity}</td>
                                <td>${item.area}</td>
                               
                                <td>โจ${item.rate.toFixed(2)}</td>
                                ${settings.showStandardRates ? `<td>โจ${item.standardRate.toFixed(2)}</td>` : ''}
                                <td>โจ${item.amount.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="${settings.showStandardRates ? 7 : 6}" class="text-end"><strong>Subtotal:</strong></td>
                            <td>โจ${currentInvoiceData.subtotal.toFixed(2)}</td>
                        </tr>
                        <tr class="table-primary">
                            <td colspan="${settings.showStandardRates ? 7 : 6}" class="text-end"><strong>Amount Paid:</strong></td>
                            <td>โจ${currentInvoiceData.amountPaid.toFixed(2)}</td>
                        </tr>
                        <tr class="table-warning">
                            <td colspan="${settings.showStandardRates ? 7 : 6}" class="text-end"><strong>Balance Due:</strong></td>
                            <td>โจ${currentInvoiceData.balanceDue.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="invoice-footer">
                    <p><strong>Notes:</strong> Thank you for your business!</p>
                    <p class="text-center">Please make checks payable to Raza Glass and Aluminum</p>
                </div>
            `;
            
            // Show modal
            const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            invoiceModal.show();
        }

        function downloadInvoice() {
            if (!currentInvoiceData) return;
            
            const doc = new jsPDF();
            
            // Company Information
            doc.setFontSize(18);
            doc.text('Raza Glass and Aluminum', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Phularwan', 105, 22, { align: 'center' });
            doc.text('Phone: 0302-7026191 | Email:  Sabeelkhan@gmail.com', 105, 28, { align: 'center' });
            
            // Invoice Title
            doc.setFontSize(16);
            doc.text('INVOICE', 105, 40, { align: 'center' });
            
            // Client Information
            doc.setFontSize(12);
            doc.text(`Client: ${currentInvoiceData.clientName}`, 14, 50);
            doc.text(`Phone: ${currentInvoiceData.clientNumber}`, 14, 56);
            doc.text(`Address: ${currentInvoiceData.clientAddress}`, 14, 62);
            
            // Invoice Details
            doc.text(`Invoice #: INV-${currentInvoiceData.orderId.toString().slice(-6)}`, 160, 50);
            doc.text(`Date: ${currentInvoiceData.date}`, 160, 56);
            doc.text(`Status: ${currentInvoiceData.paymentStatus}`, 160, 62);
            doc.text(`Mode: ${currentInvoiceData.measurementMode === 'accurate' ? 'Accurate (รท144)' : 'Market (รท100)'}`, 160, 68);
            
            // Order Items Table
            const headers = settings.showStandardRates 
                ? [['No', 'Description', 'Size', 'Qty', 'Area (ftยฒ)', 'Rate', 'Std Rate', 'Amount']]
                : [['No', 'Description', 'Size', 'Qty', 'Area (ftยฒ)', 'Rate', 'Amount']];
                
            const itemsData = currentInvoiceData.items.map((item, index) => {
                const row = [
                    index + 1,
                    item.description,
                    item.size,
                    item.quantity,
                    item.area,
                    item.rate.toFixed(2)
                ];
                
                if (settings.showStandardRates) {
                    row.push(item.standardRate.toFixed(2));
                }
                
                row.push(item.amount.toFixed(2));
                return row;
            });
            
            doc.autoTable({
                startY: 80,
                head: headers,
                body: itemsData,
                theme: 'grid',
                headStyles: { fillColor: [51, 51, 51] },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 20 },
                    ...(settings.showStandardRates ? { 7: { cellWidth: 20 } } : {}),
                    [settings.showStandardRates ? 8 : 7]: { cellWidth: 25 }
                }
            });
            
            // Summary
            const finalY = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(12);
            doc.text(`Subtotal: โจ${currentInvoiceData.subtotal.toFixed(2)}`, 160, finalY ,{ align: 'center' });
            doc.text(`Amount Paid: โจ${currentInvoiceData.amountPaid.toFixed(2)}`, 160, finalY + 6);
            doc.text(`Balance Due: โจ${currentInvoiceData.balanceDue.toFixed(2)}`, 160, finalY + 12);
            
            // Terms and Conditions
            doc.setFontSize(10);
            doc.text('Terms & Conditions:', 14, finalY + 24);
            doc.text('1. Goods once sold will not be taken back.', 14, finalY + 30);
            doc.text('2. Payment due upon delivery unless otherwise agreed.', 14, finalY + 36);
            doc.text('3. Warranty does not cover breakage due to mishandling.', 14, finalY + 42);
            
            // Save the PDF
            doc.save(`Invoice_INV-${currentInvoiceData.orderId.toString().slice(-6)}_${currentInvoiceData.clientName.replace(/\s+/g, '_')}.pdf`);
        }

        function printInvoice() {
            if (!currentInvoiceData) return;
            
            // Create print content
            const printContainer = document.getElementById('invoicePrintContainer');
            printContainer.innerHTML = document.getElementById('invoicePreview').innerHTML;
            
            // Trigger print
            window.print();
        }

        function updateSalesTable() {
            const container = document.getElementById('clientTablesContainer');
            container.innerHTML = '';
            
            // Group by client (name + number as unique identifier)
            const clientOrders = {};
            salesData.forEach(sale => {
                const clientKey = `${sale.clientName}_${sale.clientNumber}`;
                if (!clientOrders[clientKey]) {
                    clientOrders[clientKey] = {
                        clientName: sale.clientName,
                        clientNumber: sale.clientNumber,
                        clientAddress: sale.clientAddress,
                        orders: {}
                    };
                }
                
                // Group by orderId within each client
                if (!clientOrders[clientKey].orders[sale.orderId]) {
                    clientOrders[clientKey].orders[sale.orderId] = {
                        paymentStatus: sale.paymentStatus,
                        date: sale.date,
                        isCompleted: sale.isCompleted,
                        items: [],
                        totalAmount: 0,
                        amountPaid: 0,
                        remainingBalance: 0,
                        measurementMode: sale.measurementMode
                    };
                }
                
                clientOrders[clientKey].orders[sale.orderId].items.push(sale);
                clientOrders[clientKey].orders[sale.orderId].totalAmount += parseFloat(sale.totalPrice);
                clientOrders[clientKey].orders[sale.orderId].amountPaid += parseFloat(sale.amountPaid);
                clientOrders[clientKey].orders[sale.orderId].remainingBalance += parseFloat(sale.remainingBalance);
            });
            
            // Create a table for each client
            Object.values(clientOrders).forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'client-table-container mb-4 p-3 border rounded';
                
                // Client header with export button
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-center mb-3';
                header.innerHTML = `
                    <h3 class="mb-0">Client: <strong>${client.clientName}</strong> (${client.clientNumber}) - ${client.clientAddress}</h3>
                    <button class="btn btn-sm btn-primary export-client-btn" 
                            onclick="exportClientData('${client.clientName}', '${client.clientNumber}')">
                        Export
                    </button>
                `;
                clientDiv.appendChild(header);
                
                // Create table for each order of this client
                Object.entries(client.orders).forEach(([orderId, order]) => {
                    const table = document.createElement('table');
                    table.className = `table table-bordered table-striped mb-3 ${order.isCompleted ? 'completed-order' : ''}`;
                    
                    // Table header
                    const thead = document.createElement('thead');
                    thead.className = 'table-dark';
                    thead.innerHTML = `
                        <tr>
                            <th>Glass Type</th>
                            <th>Thickness</th>
                            <th>Width</th>
                            <th>Height</th>
                            <th>Qty</th>
                            <th>Total Price</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Mode</th>
                            <th>Action</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    
                    // Table body
                    const tbody = document.createElement('tbody');
                    order.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.glassType}</td>
                            <td>${item.thickness}</td>
                            <td>${item.width}</td>
                            <td>${item.height}</td>
                            <td>${item.quantity}</td>
                            <td>โจ${item.totalPrice.toFixed(2)}</td>
                            <td>${item.paymentStatus}</td>
                            <td>${item.date}</td>
                            <td>${item.measurementMode === 'accurate' ? 'Accurate' : 'Market'}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteOrder(${item.orderId})"><i class="bi bi-trash"></i></button>
                                <button class="btn btn-warning btn-sm ms-1" onclick="editOrder(${item.orderId})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-info btn-sm ms-1" onclick="showSingleInvoice(${item.orderId})"><i class="bi bi-file-text"></i></button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Add summary row
                    const summaryRow = document.createElement('tr');
                    summaryRow.className = 'order-summary';
                    summaryRow.innerHTML = `
                        <td colspan="5"><strong>Order Summary</strong></td>
                        <td><strong>โจ${order.totalAmount.toFixed(2)}</strong></td>
                        <td><strong>${order.paymentStatus}</strong></td>
                        <td>${order.date}</td>
                        <td>${order.measurementMode === 'accurate' ? 'Accurate' : 'Market'}</td>
                        <td></td>
                    `;
                    tbody.appendChild(summaryRow);
                    
                    // Add payment summary row
                    const paymentRow = document.createElement('tr');
                    paymentRow.className = 'order-summary';
                    paymentRow.innerHTML = `
                        <td colspan="5"><strong>Payment Summary</strong></td>
                        <td><strong>Paid: โจ${order.amountPaid.toFixed(2)}</strong></td>
                        <td><strong>Balance: โจ${order.remainingBalance.toFixed(2)}</strong></td>
                        <td colspan="3"></td>
                    `;
                    tbody.appendChild(paymentRow);
                    
                    table.appendChild(tbody);
                    clientDiv.appendChild(table);
                });
                
                container.appendChild(clientDiv);
            });
        }

        function showSingleInvoice(orderId) {
            currentOrderId = orderId;
            showInvoiceModal();
        }

        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this entire order?')) {
                salesData = salesData.filter(item => item.orderId !== orderId);
                localStorage.setItem('salesData', JSON.stringify(salesData));
                updateSalesTable();
                calculateTotals();
            }
        }

        function calculateTotals() {
            const totalSales = salesData.reduce((total, sale) => total + parseFloat(sale.totalPrice), 0);
            const totalPending = salesData.reduce((total, sale) => {
                if (sale.paymentStatus !== 'Paid') {
                    return total + parseFloat(sale.remainingBalance);
                }
                return total;
            }, 0);
            const totalCompleted = salesData.reduce((total, sale) => {
                if (sale.paymentStatus === 'Paid') {
                    return total + parseFloat(sale.totalPrice);
                }
                return total;
            }, 0);
            
            document.getElementById('totalSales').textContent = totalSales.toFixed(2);
            document.getElementById('totalPending').textContent = totalPending.toFixed(2);
        }

        // Export All Data functionality
        document.getElementById('exportAllData').addEventListener('click', function() {
            const allData = {
                salesData: salesData,
                clientsData: clientsData,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const fileName = `RazaGlass_AllData_${new Date().toISOString().slice(0,10)}.json`;
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Import All Data functionality
        document.getElementById('importAllData').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Check if it's single client data or full database
                        if (importedData.clientInfo && importedData.orders) {
                            // SINGLE CLIENT DATA IMPORT
                            if (confirm('Ek client ki data import ho rahi hai. Import karna hai?')) {
                                // Check if client already exists
                                const clientExists = clientsData.some(
                                    client => client.number === importedData.clientInfo.number
                                );
                                
                                if (!clientExists) {
                                    clientsData.push(importedData.clientInfo);
                                    localStorage.setItem('clientsData', JSON.stringify(clientsData));
                                }
                                
                                // Add orders to salesData
                                importedData.orders.forEach(order => {
                                    if (!salesData.some(item => item.orderId === order.orderId)) {
                                        salesData.push(order);
                                    }
                                });
                                
                                localStorage.setItem('salesData', JSON.stringify(salesData));
                                updateSalesTable();
                                calculateTotals();
                                alert('Single client data successfully imported!');
                            }
                        } 
                        else if (importedData.salesData || importedData.clientsData) {
                            // FULL DATABASE IMPORT
                            if (confirm('Poori database import ho rahi hai. Sab existing data replace ho jayega. Continue?')) {
                                salesData = importedData.salesData || [];
                                clientsData = importedData.clientsData || [];
                                
                                localStorage.setItem('salesData', JSON.stringify(salesData));
                                localStorage.setItem('clientsData', JSON.stringify(clientsData));
                                
                                updateSalesTable();
                                calculateTotals();
                                alert('Complete database imported successfully!');
                            }
                        } 
                        else {
                            alert('Invalid file format. Please select a valid export file.');
                        }
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                        console.error('Import error:', error);
                    }
                };
                
                reader.onerror = function() {
                    alert('File read error');
                };
                
                reader.readAsText(file);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        });

        function exportClientData(clientName, clientNumber) {
            // Filter sales data for this specific client
            const clientSalesData = salesData.filter(item => 
                item.clientName === clientName && item.clientNumber === clientNumber
            );
            
            // Find client info
            const clientInfo = clientsData.find(client => client.number === clientNumber) || {
                name: clientName,
                number: clientNumber,
                address: ""
            };

            // Prepare data for export
            const exportData = {
                clientInfo: clientInfo,
                orders: clientSalesData,
                exportedAt: new Date().toISOString()
            };

            // Create and download JSON file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const fileName = `RazaGlass_${clientName.replace(/\s+/g, '_')}_${clientNumber}.json`;
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        let lastSelectedThickness = ""; // Yeh variable last selected thickness store karega
        document.getElementById('newThickness').addEventListener('change', function() {
    lastSelectedThickness = this.value; // Store the selected thickness
    updatePricePerSqFeet();
});

    </script>
</body>
</html>